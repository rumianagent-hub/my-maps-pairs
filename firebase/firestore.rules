rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ──────────────────────────────────────────────────────

    /** Returns true if the request is from an authenticated user */
    function isSignedIn() {
      return request.auth != null;
    }

    /** Returns true if the requesting user owns the document */
    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    /** Returns true if the requesting user is in the pair's members array */
    function isPairMember(pairId) {
      return isSignedIn() &&
        pairId != null &&
        exists(/databases/$(database)/documents/pairs/$(pairId)) &&
        request.auth.uid in get(/databases/$(database)/documents/pairs/$(pairId)).data.members;
    }

    /** Returns true if requester can read the target user's profile via shared active pair */
    function canReadUser(uid) {
      return isSignedIn() &&
        (
          isOwner(uid) ||
          (
            exists(/databases/$(database)/documents/users/$(uid)) &&
            get(/databases/$(database)/documents/users/$(uid)).data.activePairId != null &&
            isPairMember(get(/databases/$(database)/documents/users/$(uid)).data.activePairId)
          )
        );
    }

    // ── users collection ─────────────────────────────────────────────────────
    match /users/{uid} {
      // Owner can always read; pair members can read each other via shared active pair
      allow get: if canReadUser(uid);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(uid);
      allow update: if isSignedIn() && isOwner(uid);
      // No delete — users can't delete their own profile
    }

    // ── pairs collection ─────────────────────────────────────────────────────
    match /pairs/{pairId} {
      // Members can read their pair
      allow read: if isSignedIn() &&
        request.auth.uid in resource.data.members;

      // Only Cloud Functions can create/update pairs (via Admin SDK)
      // Direct writes from client are blocked intentionally.
      allow write: if false;
    }

    // ── restaurants collection ───────────────────────────────────────────────
    match /restaurants/{restaurantId} {
      // Single-document reads must belong to a pair the requester is in
      allow get: if isPairMember(resource.data.pairId);
      // Collection queries can't safely reference resource.data at rule-eval time
      allow list: if isSignedIn();

      // Only Cloud Functions write restaurants
      allow write: if false;
    }

    // ── votes collection ─────────────────────────────────────────────────────
    match /votes/{voteId} {
      // Single-document reads must belong to a pair the requester is in
      allow get: if isPairMember(resource.data.pairId);
      // Collection queries can't safely reference resource.data at rule-eval time
      allow list: if isSignedIn();

      // Only Cloud Functions write votes
      allow write: if false;
    }

    // ── events collection ────────────────────────────────────────────────────
    match /events/{eventId} {
      // Users can read their own events; pair members can read pair events
      allow read: if isSignedIn() &&
        (resource.data.userId == request.auth.uid ||
         (resource.data.pairId != null && isPairMember(resource.data.pairId)));

      // Analytics events can be written directly from the client (for UX speed)
      // but only by the authenticated user for their own events
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      allow update, delete: if false;
    }
  }
}
